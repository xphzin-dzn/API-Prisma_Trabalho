<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Produtos</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Produtos</h1>
    <input type="text" id="search-input" placeholder="Pesquisar por descrição">
    <button id="search-button">Buscar</button>
    <ul id="produtos-list"></ul>

    <h2>Criar Produto</h2>
    <form id="create-produto">
        <input type="text" placeholder="Descrição" required>
        <input type="number" placeholder="Quantidade" required>
        <input type="number" step="0.01" placeholder="Valor" required>
        <select id="proprietario-select" required></select>
        <button type="submit">Criar</button>
    </form>

    <h2>Editar Produto</h2>
    <form id="edit-produto" class="hidden">
        <input type="hidden" id="edit-id">
        <input type="text" placeholder="Descrição" id="edit-descricao" required>
        <input type="number" placeholder="Quantidade" id="edit-quantidade" required>
        <input type="number" step="0.01" placeholder="Valor" id="edit-valor" required>
        <select id="edit-proprietario-select" required></select>
        <button type="submit">Atualizar</button>
    </form>

    <script>
        let proprietarios = {}; // Armazenar proprietários em um objeto

        function loadProdutos() {
            fetch('/api/produtos')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('produtos-list');
                    list.innerHTML = '';
                    data.forEach(produto => {
                        const li = document.createElement('li');
                        // Usar a ID do proprietário para pegar o nome
                        const proprietarioNome = proprietarios[produto.proprietarioId] ? proprietarios[produto.proprietarioId].nome : 'Sem proprietário';
                        li.textContent = `${produto.descricao} - Quantidade: ${produto.quantidade} - Valor: R$ ${produto.valor.toFixed(2)} - Proprietário: ${proprietarioNome}`;
                        li.appendChild(createEditButton(produto.id));
                        li.appendChild(createDeleteButton(produto.id));
                        list.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar produtos:', error);
                });
        }

        function loadProprietarios() {
            fetch('/api/proprietarios')
                .then(response => response.json())
                .then(data => {
                    const selectCreate = document.getElementById('proprietario-select');
                    const selectEdit = document.getElementById('edit-proprietario-select');

                    selectCreate.innerHTML = '';
                    selectEdit.innerHTML = '';

                    data.forEach(proprietario => {
                        proprietarios[proprietario.id] = proprietario; // Armazenar no objeto
                        const optionCreate = document.createElement('option');
                        optionCreate.value = proprietario.id;
                        optionCreate.textContent = proprietario.nome;
                        selectCreate.appendChild(optionCreate);

                        const optionEdit = document.createElement('option');
                        optionEdit.value = proprietario.id;
                        optionEdit.textContent = proprietario.nome;
                        selectEdit.appendChild(optionEdit);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar proprietários:', error);
                });
        }

        function createEditButton(id) {
            const button = document.createElement('button');
            button.textContent = 'Editar';
            button.onclick = (e) => {
                e.preventDefault(); // Previne o comportamento padrão
                editProduto(id);
            };
            return button;
        }

        function createDeleteButton(id) {
            const button = document.createElement('button');
            button.textContent = 'Deletar';
            button.onclick = () => deleteProduto(id);
            return button;
        }

        document.getElementById('create-produto').addEventListener('submit', function (e) {
            e.preventDefault();
            const descricao = this[0].value;
            const quantidade = this[1].value;
            const valor = this[2].value;
            const proprietarioId = document.getElementById('proprietario-select').value;

            fetch('/api/produtos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ descricao, quantidade, valor, proprietarioId }),
            }).then(() => {
                loadProdutos();
                this.reset();
            }).catch(error => {
                console.error('Erro ao criar produto:', error);
            });
        });

        document.getElementById('edit-produto').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const descricao = document.getElementById('edit-descricao').value;
            const quantidade = this[1].value;
            const valor = this[2].value;
            const proprietarioId = document.getElementById('edit-proprietario-select').value;

            fetch(`/api/produtos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ descricao, quantidade, valor, proprietarioId }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao atualizar o produto');
                    }
                    return response.json();
                })
                .then(() => {
                    loadProdutos();
                    this.reset();
                    this.classList.add('hidden');
                })
                .catch(error => {
                    console.error('Erro ao atualizar produto:', error);
                });
        });

        function editProduto(id) {
            fetch(`/api/produtos/${id}`)
                .then(response => response.json())
                .then(produto => {
                    document.getElementById('edit-id').value = produto.id;
                    document.getElementById('edit-descricao').value = produto.descricao;
                    document.getElementById('edit-quantidade').value = produto.quantidade;
                    document.getElementById('edit-valor').value = produto.valor;
                    document.getElementById('edit-proprietario-select').value = produto.proprietarioId;

                    document.getElementById('edit-produto').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Erro ao carregar o produto:', error);
                });
        }

        function deleteProduto(id) {
            fetch(`/api/produtos/${id}`, {
                method: 'DELETE',
            }).then(() => {
                loadProdutos();
            }).catch(error => {
                console.error('Erro ao deletar produto:', error);
            });
        }

        document.getElementById('search-button').addEventListener('click', function () {
            const descricao = document.getElementById('search-input').value;
            if (descricao) {
                fetch(`/api/produtos?descricao=${descricao}`)
                    .then(response => response.json())
                    .then(data => {
                        const list = document.getElementById('produtos-list');
                        list.innerHTML = '';
                        data.forEach(produto => {
                            const li = document.createElement('li');
                            const proprietarioNome = proprietarios[produto.proprietarioId] ? proprietarios[produto.proprietarioId].nome : 'Sem proprietário';
                            li.textContent = `${produto.descricao} - Quantidade: ${produto.quantidade} - Valor: R$ ${produto.valor.toFixed(2)} - Proprietário: ${proprietarioNome}`;
                            li.appendChild(createEditButton(produto.id));
                            li.appendChild(createDeleteButton(produto.id));
                            list.appendChild(li);
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao buscar produtos:', error);
                    });
            } else {
                loadProdutos();
            }
        });

        loadProprietarios();
        loadProdutos();
    </script>

    <a href="/">Voltar</a>
</body>

</html>